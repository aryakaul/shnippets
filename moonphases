#!/bin/bash

moon_file="$HOME/.cache/moon"

dl() {
    [ -s $moon_file ] && rm "$moon_file"
    [ "$(stat -c %y $moon_file 2> /dev/null | cut -d' ' -f1)" != "$(date '+%Y-%m-%d')" ] && (curl -s https://www.moongiant.com/phase/$(date '+%m/%d/%y') > $moon_file;)
}

get_phase() {
    phase="$(grep "var jArray" $moon_file | grep -o -E "(Phase: <span>)(.*)(span)" | cut -f2 -d'<' | cut -f2 -d'>')"
    echo $phase
}

get_emoji() {

    case "$1" in 
        
    "Full Moon")
        emoji="ğŸŒ"
        ;;
        
    "Waning Gibbous")
        [[ $2 == "YES" ]] && emoji="ğŸŒ”" || emoji="ğŸŒ–"
        ;;

    "Last Quarter")
        [[ $2 == "YES" ]] && emoji="ğŸŒ“" || emoji="ğŸŒ—"
        ;;

    "Waning Crescent")
        [[ $2 == "YES" ]] && emoji="ğŸŒ’" || emoji="ğŸŒ˜"
        ;;
    
    "New Moon") 
        emoji="ğŸŒš"
        ;;

    "Waxing Crescent")
        [[ $2 == "YES" ]] && emoji="ğŸŒ˜" || emoji="ğŸŒ’"
        ;;
    
    "First Quarter")
        [[ $2 == "YES" ]] && emoji="ğŸŒ—" || emoji="ğŸŒ“"
        ;;
    
    "Waxing Gibbous")
        [[ $2 == "YES" ]] && emoji="ğŸŒ–" || emoji="ğŸŒ”"
        ;;
    esac 
    echo "$emoji $1"
}

main() {
    SOUTHERN=NO
	for i in "$@"; do
	case $i in
        -s|--southern)
        SOUTHERN=YES
        shift
        ;;
        *)    
		;;
	esac
	done
    dl
    get_emoji "$(get_phase)" "$SOUTHERN"
}

main "$@"
